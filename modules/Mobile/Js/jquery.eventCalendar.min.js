/* =
    jquery.eventCalendar.js
    version: 0.66
    date: 25-02-2015
    author:
        Jaime Fernandez (@vissit)
    company:
        Paradigma Tecnologico (@paradigmate)
*/

$.fn.eventCalendar=function(e){function t(e,t){return e.date.toLowerCase()>t.date.toLowerCase()?1:-1}function a(e,t,a){var n=$("<div class='eventsCalendar-slider'></div>"),s=$("<div class='eventsCalendar-monthWrap'></div>"),i=$("<div class='eventsCalendar-currentTitle'><a href='#' class='monthTitle'></a></div>"),d=$("<a href='#' class='arrow prev'><span>"+l.txt_prev+"</span></a><a href='#' class='arrow next'><span>"+l.txt_next+"</span></a>");if($eventsCalendarDaysList=$("<ul class='eventsCalendar-daysList'></ul>"),date=new Date,v.wrap.find(".eventsCalendar-slider").size()?v.wrap.find(".eventsCalendar-slider").append(s):(v.wrap.prepend(n),n.append(s)),v.wrap.find(".eventsCalendar-monthWrap.currentMonth").removeClass("currentMonth").addClass("oldMonth"),s.addClass("currentMonth").append(i,$eventsCalendarDaysList),"current"===e)day=date.getDate(),n.append(d);else{date=new Date(v.wrap.attr("data-current-year"),v.wrap.attr("data-current-month"),1,0,0,0),day=0,moveOfMonth=1,"prev"===e&&(moveOfMonth=-1),date.setMonth(date.getMonth()+moveOfMonth);var o=new Date;date.getMonth()===o.getMonth()&&(day=o.getDate())}var t=date.getFullYear(),p=(new Date).getFullYear(),a=date.getMonth();"current"!=e&&r(l.eventsLimit,t,a,!1,e),v.wrap.attr("data-current-month",a).attr("data-current-year",t),i.find(".monthTitle").html(l.monthNames[a]+" "+t);var c=32-new Date(t,a,32).getDate(),h=[];if(l.showDayAsWeeks){if($eventsCalendarDaysList.addClass("showAsWeek"),l.showDayNameInCalendar){$eventsCalendarDaysList.addClass("showDayNames");var f=0;for(l.startWeekOnMonday&&(f=1);7>f;f++)h.push('<li class="eventsCalendar-day-header">'+l.dayNamesShort[f]+"</li>"),6===f&&l.startWeekOnMonday&&h.push('<li class="eventsCalendar-day-header">'+l.dayNamesShort[0]+"</li>")}dt=new Date(t,a,1);var u=dt.getDay();for(l.startWeekOnMonday&&(u=dt.getDay()-1),0>u&&(u=6),f=u;f>0;f--)h.push('<li class="eventsCalendar-day empty"></li>')}for(dayCount=1;dayCount<=c;dayCount++){var m="";day>0&&dayCount===day&&t===p&&(m="today"),h.push('<li id="dayList_'+dayCount+'" rel="'+dayCount+'" class="eventsCalendar-day '+m+'"><a href="#">'+dayCount+"</a></li>")}$eventsCalendarDaysList.append(h.join("")),n.css("height",s.height()+"px")}function n(e){var t,a=e.length,n=e.charAt(a-1);return t=2===a&&"1"===e.charAt(0)?l.txt_NumAbbrevTh:"1"===n?l.txt_NumAbbrevSt:"2"===n?l.txt_NumAbbrevNd:"3"===n?l.txt_NumAbbrevRd:l.txt_NumAbbrevTh,e+t}function r(e,t,a,n,r){var e=e||0,t=t||"",n=n||"";if("undefined"!=typeof a)var a=a;else var a="";v.wrap.find(".eventsCalendar-loading").fadeIn(),l.jsonData?(l.cacheJson=!0,v.eventsJson=l.jsonData,s(v.eventsJson,e,t,a,n,r)):l.cacheJson&&r?s(v.eventsJson,e,t,a,n,r):$.getJSON(l.eventsjson+"?limit="+e+"&year="+t+"&month="+a+"&day="+n,function(i){v.eventsJson=i,s(v.eventsJson,e,t,a,n,r)}).error(function(){d("error getting json: ")}),n>""&&(v.wrap.find(".current").removeClass("current"),v.wrap.find("#dayList_"+n).addClass("current"))}function s(e,a,r,s,i,d){directionLeftMove="-="+v.directionLeftMove,eventContentHeight="auto",subtitle=v.wrap.find(".eventsCalendar-list-wrap .eventsCalendar-subtitle"),d?(subtitle.html(""!=i?l.txt_SpecificEvents_prev+l.monthNames[s]+" "+n(i)+" "+l.txt_SpecificEvents_after:l.txt_SpecificEvents_prev+l.monthNames[s]+" "+l.txt_SpecificEvents_after),"prev"===d?directionLeftMove="+="+v.directionLeftMove:("day"===d||"month"===d)&&(directionLeftMove="+=0",eventContentHeight=0)):(subtitle.html(l.txt_NextEvents),eventContentHeight="auto",directionLeftMove="-=0"),v.wrap.find(".eventsCalendar-list").animate({opacity:l.moveOpacity,left:directionLeftMove,height:eventContentHeight},l.moveSpeed,function(){v.wrap.find(".eventsCalendar-list").css({left:0,height:"auto"}).hide();var n=[];if(e=$(e).sort(t),e.length){var d="";l.showDescription||(d="hidden");var o="_self";l.openEventInNewWindow&&(o="_target");var p=0;$.each(e,function(e,t){if("human"==l.jsonDateFormat)var c=t.date.split(" "),h=c[0].split("-"),f=c[1].split(":"),u=h[0],m=parseInt(h[1])-1,w=parseInt(h[2]),y=(parseInt(m)+1,f[0]),C=f[1],g=f[2],h=new Date(u,m,w,y,C,g);else var h=new Date(parseInt(t.date)),u=h.getFullYear(),m=h.getMonth(),w=h.getDate(),y=h.getHours(),C=h.getMinutes();if(parseInt(C)<=9&&(C="0"+parseInt(C)),(0===a||a>p)&&!(s!==!1&&s!=m||""!=i&&i!=w||""!=r&&r!=u))if(s===!1&&h<new Date);else{if(eventStringDate=moment(h).format(l.dateFormat),t.url)var D='<a href="'+t.url+'" target="'+o+'" class="eventTitle">'+t.title+"</a>";else var D='<span class="eventTitle">'+t.title+"</span>";n.push('<li id="'+e+'" class="'+t.type+'"><time datetime="'+h+'"><em>'+eventStringDate+"</em><small>"+y+":"+C+"</small></time>"+D+'<p class="eventDesc '+d+'">'+t.description+"</p></li>"),p++}u==v.wrap.attr("data-current-year")&&m==v.wrap.attr("data-current-month")&&v.wrap.find(".currentMonth .eventsCalendar-daysList #dayList_"+parseInt(w)).addClass("dayWithEvents")})}n.length||n.push('<li class="eventsCalendar-noEvents"><p>'+l.txt_noEvents+"</p></li>"),v.wrap.find(".eventsCalendar-loading").hide(),v.wrap.find(".eventsCalendar-list").html(n.join("")),v.wrap.find(".eventsCalendar-list").animate({opacity:1,height:"toggle"},l.moveSpeed)}),o()}function i(){v.wrap.find(".arrow").click(function(e){if(e.preventDefault(),$(this).hasClass("next")){a("next");var t="-="+v.directionLeftMove}else{a("prev");var t="+="+v.directionLeftMove}v.wrap.find(".eventsCalendar-monthWrap.oldMonth").animate({opacity:l.moveOpacity,left:t},l.moveSpeed,function(){v.wrap.find(".eventsCalendar-monthWrap.oldMonth").remove()})})}function d(e){v.wrap.find(".eventsCalendar-list-wrap").html("<span class='eventsCalendar-loading error'>"+e+" "+l.eventsjson+"</span>")}function o(){v.directionLeftMove=v.wrap.width(),v.wrap.find(".eventsCalendar-monthWrap").width(v.wrap.width()+"px"),v.wrap.find(".eventsCalendar-list-wrap").width(v.wrap.width()+"px")}var l=$.extend({},$.fn.eventCalendar.defaults,e),v={wrap:"",directionLeftMove:"300",eventsJson:{}};this.each(function(){v.wrap=$(this),v.wrap.addClass("eventCalendar-wrap").append("<div class='eventsCalendar-list-wrap'><p class='eventsCalendar-subtitle'></p><span class='eventsCalendar-loading'>"+l.txt_loading+"</span><div class='eventsCalendar-list-content'><ul class='eventsCalendar-list'></ul></div></div>"),l.eventsScrollable&&v.wrap.find(".eventsCalendar-list-content").addClass("scrollable"),o(),$(window).resize(function(){o()}),a("current"),r(l.eventsLimit,!1,!1,!1,!1),i(),v.wrap.on("click",".eventsCalendar-day a",function(e){e.preventDefault();var t=v.wrap.attr("data-current-year"),a=v.wrap.attr("data-current-month"),n=$(this).parent().attr("rel");r(!1,t,a,n,"day")}),v.wrap.on("click",".monthTitle",function(e){e.preventDefault();var t=v.wrap.attr("data-current-year"),a=v.wrap.attr("data-current-month");r(l.eventsLimit,t,a,!1,"month")})}),v.wrap.find(".eventsCalendar-list").on("click",".eventTitle",function(e){if(!l.showDescription){e.preventDefault();var t=$(this).parent().find(".eventDesc");if(!t.find("a").size()){var a=$(this).attr("href"),n=$(this).attr("target");t.append('<a href="'+a+'" target="'+n+'" class="bt">'+l.txt_GoToEventUrl+"</a>")}t.is(":visible")?t.slideUp():(l.onlyOneDescription&&v.wrap.find(".eventDesc").slideUp(),t.slideDown())}})},$.fn.eventCalendar.defaults={eventsjson:"js/events.json",eventsLimit:12,monthNames:["January","February","March","April","May","June","July","August","September","October","November","December"],dayNames:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],dayNamesShort:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],txt_noEvents:"There are no events in this period",txt_SpecificEvents_prev:"",txt_SpecificEvents_after:"events:",txt_next:"next",txt_prev:"prev",txt_NextEvents:"Next events:",txt_GoToEventUrl:"See the event",txt_NumAbbrevTh:"th",txt_NumAbbrevSt:"st",txt_NumAbbrevNd:"nd",txt_NumAbbrevRd:"rd",txt_loading:"loading...",showDayAsWeeks:!0,startWeekOnMonday:!0,showDayNameInCalendar:!0,showDescription:!1,onlyOneDescription:!0,openEventInNewWindow:!1,eventsScrollable:!1,dateFormat:"D/MM/YYYY",jsonDateFormat:"timestamp",moveSpeed:500,moveOpacity:.15,jsonData:"",cacheJson:!0};