var ImageProcessorConfig={tagName:"imageprocessor",tagNameCursor:"imagecursor",selectorBtnSave:'[pid="save"]',selectorBtnRotate:'[pid="rotate"]',attrQuality:"quality",defaultQuality:.7,attrOutputSize:"outputsize",defaultOutputSize:"300"},ImageProcessorUI={Config:ImageProcessorConfig,getAll:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:document;return e.getElementsByTagName(this.Config.tagName)},getImage:function(e){return void 0===e.__img&&(e.__img=e.getElementsByTagName("img")[0]||!1),e.__img},getCursor:function(e){return void 0===e.__cursor&&(e.__cursor=e.getElementsByTagName(this.Config.tagNameCursor)[0]||!1),e.__cursor},getSaveBtn:function(e){return e.querySelector(this.Config.selectorBtnSave)||!1},getRotateBtn:function(e){return e.querySelector(this.Config.selectorBtnSave)||!1},checkCursorWillBeInsideX:function(e,t){var i=this.getCursor(e),s=this.getImage(e);return t>=0&&i.getBoundingClientRect().width+t<=s.getBoundingClientRect().width},checkCursorWillBeInsideY:function(e,t){var i=this.getCursor(e),s=this.getImage(e);return t>=0&&i.getBoundingClientRect().height+t<=s.getBoundingClientRect().height},centerCursor:function(e){var t=this.getImage(e),i=this.getCursor(e),s=0,o=t.getBoundingClientRect();o.width>o.height?(s=o.height,i.style.left=(o.width-s)/2+"px",i.style.top="0px"):(s=o.width,i.style.left="0px",i.style.top=(o.height-s)/2+"px"),i.style.width=s+"px",i.style.height=s+"px"},moveCursor:function(e,t,i){var s=this.getImage(e),o=this.getCursor(e),n=s.getBoundingClientRect(),r=o.getBoundingClientRect();this.checkCursorWillBeInsideX(e,o.offsetLeft+t)?o.style.left=o.offsetLeft+t+"px":o.offsetLeft+t<0?o.style.left="0px":o.style.left=n.width-r.width,this.checkCursorWillBeInsideY(e,o.offsetTop+i)?o.style.top=o.offsetTop+i+"px":o.offsetTop+i<0?o.style.top="0px":o.style.top=n.height-r.height},resizeCursor:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,s=this.getImage(e),o=this.getCursor(e),n=s.getBoundingClientRect(),r=o.getBoundingClientRect(),a=r.width+t,u=0;return u=null===i?r.height+t:r.height+i,o.offsetTop+u<=n.height&&o.offsetLeft+a<=n.width&&(o.style.width=a+"px",o.style.height=u+"px",!0)}},ImageProcessor={Config:ImageProcessorConfig,UI:ImageProcessorUI,init:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;null!==t&&this.setImage(e,t),this.addEvents(e),null!==i&&this.onSave(e,i)},deinit:function(e){this.removeEvents(e),delete e.__on_save},initAll:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:document;[].forEach.call(this.UI.getAll(t),function(t){e.init(t)})},deinitAll:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:document;[].forEach.call(this.UI.getAll(t),function(t){e.deinit(t)})},addEvents:function(e){var t=this.UI.getCursor(e),i=this.UI.getImage(e),s=this.UI.getSaveBtn(e);e.__move_start=addEvent(t,"mousedown",this.handleBeginMove.bind(this,e)),e.__move_end=addEvent(window,"mouseup",this.handleEndMove.bind(this,e)),e.__zoom=addEvent(e,"wheel",this.handleZoom.bind(this,e)),e.__save=addEvent(s,"click",this.handleSave.bind(this,e)),e.__img_load=addEvent(i,"load",this.handleImgLoad.bind(this,e)),e.__keypress=addEvent(t,"keypress",this.handleKeyPress.bind(this,e))},removeEvents:function(e){var t=this.UI.getCursor(e),i=this.UI.getImage(e),s=this.UI.getSaveBtn(e);delete removeEvent(t,"mousedown",e.__move_start),delete removeEvent(window,"mouseup",e.__move_end),delete removeEvent(e,"wheel",e.__zoom),delete removeEvent(s,"click",e.__save),delete removeEvent(i,"load",e.__img_load),delete removeEvent(t,"keypress",e.__keypress)},handleKeyPress:function(e,t){t.preventDefault(),void 0===e.__key_speed&&(e.__key_speed=0),e.__key_speed++,void 0!==e.__key_timeout&&clearTimeout(e.__key_timeout),e.__key_timeout=setTimeout(function(){delete e.__key_speed,delete e.__key_timeout},100),t.keyCode===KEY_ARROW_RIGHT?t.shiftKey?this.UI.resizeCursor(e,e.__key_speed):this.UI.moveCursor(e,e.__key_speed,0):t.keyCode===KEY_ARROW_DOWN?t.shiftKey?this.UI.resizeCursor(e,-e.__key_speed):this.UI.moveCursor(e,0,e.__key_speed):t.keyCode===KEY_ARROW_LEFT?t.shiftKey?this.UI.resizeCursor(e,-e.__key_speed):this.UI.moveCursor(e,-e.__key_speed,0):t.keyCode===KEY_ARROW_UP?t.shiftKey?this.UI.resizeCursor(e,e.__key_speed):this.UI.moveCursor(e,0,-e.__key_speed):t.keyCode===KEY_ENTER&&this.handleSave(e)},setImage:function(e,t){"string"!=typeof t&&(t=URL.createObjectURL(t)),this.UI.getImage(e).src=t},setQuality:function(e,t){e.setAttribute(this.Config.attrQuality,t)},getQuality:function(e){var t=e.getAttribute(this.Config.attrQuality);return t=t?parseFloat(t):this.Config.defaultQuality},setOutputSize:function(e,t){e.setAttribute(this.Config.attrOutputSize,t)},getOutputSize:function(e){var t=e.getAttribute(this.Config.attrOutputSize);return t=t?parseFloat(t):this.Config.defaultOutputSize},handleZoom:function(e,t){t.preventDefault();var i=2*-t.deltaY;this.UI.resizeCursor(e,i)},handleImgLoad:function(e){this.UI.centerCursor(e),this.UI.getCursor(e).focus()},setMoveStartPos:function(e,t){e.__startX=t.layerX,e.__startY=t.layerY},getMoveStartPos:function(e){return[e.__startX,e.__startY]},handleMove:function(e,t){var i=this.getMoveStartPos(e),s=t.layerX,o=t.layerY,n=s-i[0],r=o-i[1];this.UI.moveCursor(e,n,r)},handleBeginMove:function(e,t){var i=this.UI.getCursor(e);i.focus(),i.classList.add("moving"),this.setMoveStartPos(e,t),e.__moving=addEvent(i,"mousemove",this.handleMove.bind(this,e))},handleEndMove:function(e,t){var i=this.UI.getCursor(e);i.classList.remove("moving"),delete removeEvent(i,"mousemove",e.__moving)},processImage:function(e,t,i){var s=BunnyImage.cropByCursor(this.UI.getImage(e),this.UI.getCursor(e));s=BunnyImage.resizeCanvas(s,t);var o=s.toDataURL("image/jpeg",i);return o},handleSave:function(e){var t=this.getOutputSize(e),i=this.getQuality(e),s=this.processImage(e,t,i);void 0!==e.__on_save&&e.__on_save.forEach(function(e){e(s)})},onSave:function(e,t){void 0===e.__on_save&&(e.__on_save=[]),e.__on_save.push(t)}};